generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

model Flow {
  id                 String               @id @default(cuid())
  name               String
  key                String               @unique
  description        String?
  isActive           Boolean              @default(false)
  startStepId        String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  connections        FlowConnection[]
  steps              FlowStep[]
  answers            FormAnswer[]
  thirdPartyTriggers ThirdPartyTrigger[]

  @@index([key])
}

model FlowStep {
  id              String           @id @default(cuid())
  flowId          String
  type            String
  label           String
  configJson      String           @default("{}")
  positionX       Int              @default(0)
  positionY       Int              @default(0)
  connectionsFrom FlowConnection[] @relation("FromStep")
  connectionsTo   FlowConnection[] @relation("ToStep")
  flow            Flow             @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
}

model FlowConnection {
  id             String   @id @default(cuid())
  flowId         String
  fromStepId     String
  toStepId       String
  conditionLabel String?
  sourceHandle   String?
  flow           Flow     @relation(fields: [flowId], references: [id], onDelete: Cascade)
  fromStep       FlowStep @relation("FromStep", fields: [fromStepId], references: [id], onDelete: Cascade)
  toStep         FlowStep @relation("ToStep", fields: [toStepId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@index([fromStepId])
  @@index([toStepId])
}

model FormAnswer {
  id          String   @id @default(cuid())
  flowId      String
  sessionId   String
  answersJson String   @default("{}")
  createdAt   DateTime @default(now())
  flow        Flow     @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@index([sessionId])
}

model SessionState {
  id            String   @id @default(cuid())
  sessionId     String   @unique
  flowId        String
  currentStepId String?
  variablesJson String   @default("{}")
  status        String   @default("active")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  assigneeId    String?
  aiTurnCount   Int      @default(0)
  assigneeType  String?

  @@index([sessionId])
  @@index([flowId])
  @@index([assigneeId])
  @@index([assigneeType])
}

model DebugAction {
  id         String   @id @default(cuid())
  sessionId  String
  actionType String
  actionData String
  createdAt  DateTime @default(now())

  @@index([sessionId])
}

model Device {
  id                    String               @id @default(cuid())
  name                  String
  color                 String               @default("#6D5BFA")
  whatsappPhoneNumberId String?
  phoneNumber           String?
  isConnected           Boolean              @default(false)
  accessToken           String?
  businessAccountId     String?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  thirdPartyTriggers    ThirdPartyTrigger[]

  @@index([isConnected])
}

model Tag {
  id        String       @id @default(cuid())
  name      String       @unique
  color     String       @default("#6D5BFA")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  contacts  ContactTag[]

  @@index([name])
}

model ContactTag {
  contactId String
  tagId     String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contactId, tagId])
  @@index([contactId])
  @@index([tagId])
}

model Contact {
  id                          String                       @id @default(cuid())
  phone                       String                       @map("phoneNumber")
  name                        String?
  email                       String?
  profileImageUrl             String?                      @map("profilePic")
  source                      String                       @default("manual")
  metadata                    String                       @default("{}")
  createdAt                   DateTime                     @default(now())
  updatedAt                   DateTime                     @updatedAt
  assignedAdminId             String?
  notes                       String?
  deviceId                    String?
  customValues                ContactCustomFieldValue[]
  tags                        ContactTag[]
  thirdPartyTriggerExecutions ThirdPartyTriggerExecution[]

  @@unique([phone, deviceId], name: "phone_device")
  @@index([phone])
  @@index([deviceId])
  @@index([source])
  @@index([assignedAdminId])
}

model Lead {
  id        String   @id @default(cuid())
  name      String?
  phone     String   @unique
  email     String?
  metadata  String   @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([phone])
}

model MessageLog {
  id        String   @id @default(cuid())
  phone     String
  message   String
  status    String   @default("pending")
  createdAt DateTime @default(now())

  @@index([phone])
  @@index([createdAt])
}

model FacebookAccount {
  id             String    @id @default(cuid())
  userId         String?
  facebookUserId String    @unique
  accessToken    String
  expiresAt      DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([userId])
}

model FacebookPageConnection {
  id              String   @id @default(cuid())
  workspaceId     String?
  pageId          String   @unique
  pageName        String
  pageAccessToken String
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([workspaceId])
  @@index([isDefault])
}

model Settings {
  id             Int     @id @default(1)
  whatsappNumber String?
  defaultAgent   String?
}

model WhatsAppConfig {
  id            String   @id @default(cuid())
  workspaceId   String?
  mode          String
  phoneNumber   String?
  phoneNumberId String?
  wabaId        String?
  accessToken   String?
  sessionId     String?
  sessionState  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([workspaceId])
  @@index([mode])
}

model CustomField {
  id        String                    @id @default(cuid())
  name      String
  key       String                    @unique
  type      String                    @default("text")
  createdAt DateTime                  @default(now())
  updatedAt DateTime                  @updatedAt
  values    ContactCustomFieldValue[]

  @@index([key])
}

model ContactCustomFieldValue {
  id            String      @id @default(cuid())
  contactId     String
  customFieldId String
  value         String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  contact       Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  customField   CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([contactId, customFieldId])
  @@index([contactId])
  @@index([customFieldId])
}

model Whalink {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  fullUrl       String
  deviceId      String
  presetMessage String
  image         String?
  description   String?
  emailKey      String?
  nameKey       String?
  trackingPixel String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([slug])
  @@index([deviceId])
}

model MassSend {
  id            String    @id @default(cuid())
  name          String
  deviceId      String
  body          String
  mediaType     String    @default("NONE")
  mediaUrl      String?
  includeTags   String    @default("[]")
  excludeTags   String    @default("[]")
  contactsFrom  DateTime?
  contactsTo    DateTime?
  sendOption    String    @default("SCHEDULED")
  scheduledAt   DateTime?
  speed         String    @default("SLOW")
  timezone      String    @default("Europe/Madrid")
  status        String    @default("DRAFT")
  totalContacts Int       @default(0)
  sentCount     Int       @default(0)
  failedCount   Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([deviceId])
  @@index([status])
  @@index([scheduledAt])
}

model ThirdPartyTrigger {
  id                 String                       @id @default(cuid())
  flowId             String
  deviceId           String
  type               String                       @default("facebook_lead")
  title              String?
  fieldMapping       String                       @default("{}")
  runOncePerContact  Boolean                      @default(false)
  lastReceivedAt     DateTime?
  lastPayloadPreview String?
  lastPayloadSample  Json?
  createdAt          DateTime                     @default(now())
  updatedAt          DateTime                     @updatedAt

  flow       Flow                            @relation(fields: [flowId], references: [id], onDelete: Cascade)
  device     Device                          @relation(fields: [deviceId], references: [id], onDelete: Cascade)
  executions ThirdPartyTriggerExecution[]

  @@index([flowId])
  @@index([deviceId])
}

model ThirdPartyTriggerExecution {
  id        String   @id @default(cuid())
  triggerId String
  contactId String
  createdAt DateTime @default(now())

  trigger ThirdPartyTrigger @relation(fields: [triggerId], references: [id], onDelete: Cascade)
  contact Contact           @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([triggerId, contactId])
  @@index([triggerId])
  @@index([contactId])
}

model AiAgent {
  id           String   @id @default(cuid())
  name         String
  description  String?
  language     String   @default("es")
  tone         String   @default("professional")
  goal         String?
  systemPrompt String   @db.Text
  maxTurns     Int      @default(20) // Updated: increased from 10 to 20 for longer conversations
  createdById  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
  @@index([createdById])
}

model ConversationMessage {
  id         String   @id @default(cuid())
  sessionId  String
  senderType String
  senderId   String?
  message    String
  metadata   String   @default("{}")
  createdAt  DateTime @default(now())

  @@index([sessionId])
  @@index([senderType])
  @@index([createdAt])
}

model Chat {
  id                 String    @id @default(cuid())
  phoneNumber        String
  contactName        String?
  lastMessagePreview String?
  lastMessageAt      DateTime  @default(now())
  unreadCount        Int       @default(0)
  status             String    @default("open")
  tags               String    @default("[]")
  deviceId           String
  isFavorite         Boolean   @default(false)
  isResponding       Boolean   @default(false) // Prevents double AI responses during delays
  assignedToUserId   String?
  assignedAgentType  String?   // "AI" or "HUMAN"
  assignedAgentId    String?   // ID of AI agent or human agent
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  messages           Message[]

  @@unique([phoneNumber, deviceId])
  @@index([phoneNumber])
  @@index([deviceId])
  @@index([status])
  @@index([assignedToUserId])
  @@index([assignedAgentType])
  @@index([assignedAgentId])
  @@index([lastMessageAt])
  @@index([isFavorite])
}

model Message {
  id        String   @id @default(cuid())
  chatId    String
  sender    String
  text      String
  status    String   @default("sent")
  messageId String?
  metadata  String   @default("{}")
  createdAt DateTime @default(now())
  chat      Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)

  @@index([chatId])
  @@index([createdAt])
  @@index([sender])
}
