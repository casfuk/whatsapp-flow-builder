// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

model Flow {
  id          String   @id @default(cuid())
  name        String
  key         String   @unique
  description String?
  isActive    Boolean  @default(false)
  startStepId String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  steps       FlowStep[]
  connections FlowConnection[]
  answers     FormAnswer[]

  @@index([key])
}

model FlowStep {
  id        String @id @default(cuid())
  flowId    String
  type      String
  label     String
  configJson String @default("{}")
  positionX Int    @default(0)
  positionY Int    @default(0)

  flow            Flow             @relation(fields: [flowId], references: [id], onDelete: Cascade)
  connectionsFrom FlowConnection[] @relation("FromStep")
  connectionsTo   FlowConnection[] @relation("ToStep")

  @@index([flowId])
}

model FlowConnection {
  id             String  @id @default(cuid())
  flowId         String
  fromStepId     String
  toStepId       String
  conditionLabel String?
  sourceHandle   String? // For multiple choice nodes: the option ID that leads to this connection

  flow     Flow     @relation(fields: [flowId], references: [id], onDelete: Cascade)
  fromStep FlowStep @relation("FromStep", fields: [fromStepId], references: [id], onDelete: Cascade)
  toStep   FlowStep @relation("ToStep", fields: [toStepId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@index([fromStepId])
  @@index([toStepId])
}

model FormAnswer {
  id          String   @id @default(cuid())
  flowId      String
  sessionId   String
  answersJson String   @default("{}")
  createdAt   DateTime @default(now())

  flow Flow @relation(fields: [flowId], references: [id], onDelete: Cascade)

  @@index([flowId])
  @@index([sessionId])
}

model SessionState {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  flowId          String
  currentStepId   String?
  variablesJson   String   @default("{}")
  status          String   @default("active") // active, completed, stopped
  assigneeId      String?  // Agent/user assigned to this conversation
  assigneeType    String?  // human, ai
  aiTurnCount     Int      @default(0) // Track turns for AI agent conversations
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([sessionId])
  @@index([flowId])
  @@index([assigneeId])
  @@index([assigneeType])
}

model DebugAction {
  id          String   @id @default(cuid())
  sessionId   String
  actionType  String
  actionData  String
  createdAt   DateTime @default(now())

  @@index([sessionId])
}

model Device {
  id                     String   @id @default(cuid())
  name                   String
  color                  String   @default("#6D5BFA")
  whatsappPhoneNumberId  String?
  phoneNumber            String?
  isConnected            Boolean  @default(false)
  accessToken            String?
  businessAccountId      String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  @@index([isConnected])
}

model Tag {
  id        String       @id @default(cuid())
  name      String       @unique
  color     String       @default("#6D5BFA")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  contacts ContactTag[]

  @@index([name])
}

model ContactTag {
  contactId String
  tagId     String

  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([contactId, tagId])
  @@index([contactId])
  @@index([tagId])
}

model Contact {
  id              String   @id @default(cuid())
  name            String?
  phone           String   @unique @map("phoneNumber")
  email           String?
  profileImageUrl String?  @map("profilePic")
  notes           String?  @db.Text
  assignedAdminId String?
  source          String   @default("manual") // whatsapp, form, manual
  metadata        String   @default("{}")
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tags         ContactTag[]
  customValues ContactCustomFieldValue[]

  @@index([phone])
  @@index([source])
  @@index([assignedAdminId])
}

model Lead {
  id          String   @id @default(cuid())
  name        String?
  phone       String   @unique
  email       String?
  metadata    String   @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([phone])
}

model MessageLog {
  id          String   @id @default(cuid())
  phone       String
  message     String
  status      String   @default("pending") // pending, sent, failed
  createdAt   DateTime @default(now())

  @@index([phone])
  @@index([createdAt])
}

model FacebookAccount {
  id              String   @id @default(cuid())
  userId          String?
  facebookUserId  String   @unique
  accessToken     String
  expiresAt       DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
}

model FacebookPageConnection {
  id              String   @id @default(cuid())
  workspaceId     String?
  pageId          String   @unique
  pageName        String
  pageAccessToken String
  isDefault       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([workspaceId])
  @@index([isDefault])
}

model Settings {
  id             Int     @id @default(1)
  whatsappNumber String?
  defaultAgent   String?
}

model WhatsAppConfig {
  id            String   @id @default(cuid())
  workspaceId   String?
  mode          String   // "cloud_api" | "qr_session"
  phoneNumber   String?
  phoneNumberId String?  // For cloud_api
  wabaId        String?  // For cloud_api
  accessToken   String?  // For cloud_api
  sessionId     String?  // For qr_session
  sessionState  String?  // For qr_session
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([workspaceId])
  @@index([mode])
}

model CustomField {
  id        String   @id @default(cuid())
  name      String
  key       String   @unique // Slugified version of name for programmatic access
  type      String   @default("text") // text, number, date, url
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  values ContactCustomFieldValue[]

  @@index([key])
}

model ContactCustomFieldValue {
  id            String   @id @default(cuid())
  contactId     String
  customFieldId String
  value         String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contact     Contact     @relation(fields: [contactId], references: [id], onDelete: Cascade)
  customField CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)

  @@unique([contactId, customFieldId])
  @@index([contactId])
  @@index([customFieldId])
}

model Whalink {
  id              String   @id @default(cuid())
  name            String
  slug            String   @unique
  fullUrl         String
  deviceId        String
  presetMessage   String
  image           String?
  description     String?
  emailKey        String?
  nameKey         String?
  trackingPixel   String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([slug])
  @@index([deviceId])
}

model MassSend {
  id             String   @id @default(cuid())
  name           String   // Title of the broadcast
  deviceId       String   // WhatsApp device ID
  body           String   // Message text with merge tags
  mediaType      String   @default("NONE") // IMAGE, VIDEO, NONE
  mediaUrl       String?
  includeTags    String   @default("[]") // JSON array of tag IDs to include
  excludeTags    String   @default("[]") // JSON array of tag IDs to exclude
  contactsFrom   DateTime?
  contactsTo     DateTime?
  sendOption     String   @default("SCHEDULED") // NOW, SCHEDULED
  scheduledAt    DateTime?
  speed          String   @default("SLOW") // SLOW, MEDIUM, FAST
  timezone       String   @default("Europe/Madrid")
  status         String   @default("DRAFT") // DRAFT, SCHEDULED, SENDING, COMPLETED, CANCELLED
  totalContacts  Int      @default(0)
  sentCount      Int      @default(0)
  failedCount    Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([deviceId])
  @@index([status])
  @@index([scheduledAt])
}

model AiAgent {
  id           String   @id @default(cuid())
  name         String
  description  String?
  language     String   @default("es") // Language for responses
  tone         String   @default("professional") // professional, friendly, casual, formal
  goal         String?  // What this agent is trying to achieve
  systemPrompt String   @db.Text // Full system prompt for the AI
  maxTurns     Int      @default(10) // Max conversation turns before handover
  createdById  String?  // User who created this agent
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
  @@index([createdById])
}

model ConversationMessage {
  id             String   @id @default(cuid())
  sessionId      String
  senderType     String   // USER, AI_AGENT, HUMAN_AGENT
  senderId       String?  // AiAgent ID or Human Agent ID
  message        String   @db.Text
  metadata       String   @default("{}") // JSON for extra data
  createdAt      DateTime @default(now())

  @@index([sessionId])
  @@index([senderType])
  @@index([createdAt])
}

model Chat {
  id                   String    @id @default(cuid())
  phoneNumber          String
  contactName          String?
  lastMessagePreview   String?   @db.Text
  lastMessageAt        DateTime  @default(now())
  unreadCount          Int       @default(0)
  status               String    @default("open") // open, closed
  tags                 String    @default("[]") // JSON array of tag IDs
  deviceId             String
  isFavorite           Boolean   @default(false)
  assignedToUserId     String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  messages             Message[]

  @@index([phoneNumber])
  @@index([deviceId])
  @@index([status])
  @@index([assignedToUserId])
  @@index([lastMessageAt])
  @@index([isFavorite])
  @@unique([phoneNumber, deviceId])
}

model Message {
  id          String   @id @default(cuid())
  chatId      String
  chat        Chat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender      String   // "agent" or "contact"
  text        String   @db.Text
  status      String   @default("sent") // sent, delivered, read, failed
  messageId   String?  // WhatsApp message ID for tracking
  metadata    String   @default("{}") // JSON for media URLs, etc.
  createdAt   DateTime @default(now())

  @@index([chatId])
  @@index([createdAt])
  @@index([sender])
}
